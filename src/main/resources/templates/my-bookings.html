<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Bookings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/custom.css}" /> <!-- Link custom CSS -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Styles for the modal */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            max-width: 500px; width: 90%; transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        /* Subtle Zebra Striping */
        .booking-list > div:nth-child(odd) { background-color: #f9fafb; }
        .booking-list > div:hover { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-100">
    <div th:replace="~{header :: navbar}"></div>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">My Bookings</h1>

        <!-- Messages -->
        <div th:if="${successMessage}" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-md shadow-sm" role="alert">
            <p class="font-bold">Success</p>
            <p th:text="${successMessage}"></p>
        </div>
        <div th:if="${errorMessage}" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-sm" role="alert">
             <p class="font-bold">Error</p>
            <p th:text="${errorMessage}"></p>
        </div>

        <!-- No Bookings Message -->
        <div th:if="${bookings.isEmpty()}" class="text-center py-16 bg-white rounded-lg shadow-md">
             <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3 7.5a9 9 0 11-6 0 4.5 4.5 0 11-3 0 2.25 2.25 0 00-1.5 0v-2.25m1.5 0A3.99 3.99 0 0112 15m0 0a3.99 3.99 0 011.5 0m-3 0A3.99 3.99 0 0012 15m2.25-4.501.071.072m-.071-.072a3 3 0 10-4.242 0m4.242 0a3 3 0 11-4.242 0M12 10.5h.008v.008H12V10.5z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900">No Bookings Found</h3>
            <p class="mt-1 text-sm text-gray-500">You haven't booked any flights yet.</p>
            <a th:href="@{/}" class="mt-6 inline-block btn btn-primary">Search Flights Now</a>
        </div>

        <!-- Booking List -->
        <div th:if="${!bookings.isEmpty()}" class="space-y-6 booking-list"> <!-- Added class for zebra striping -->
            <!-- Iterate over BookingSummaryDTO objects -->
            <div th:each="booking : ${bookings}"
                 class="bg-white rounded-lg shadow-lg overflow-hidden border-l-4 transition-colors duration-150"
                 th:classappend="${booking.status == 'CONFIRMED' ? 'border-green-500' : (booking.status == 'CANCELLED' ? 'border-red-500' : 'border-gray-300')}">

                <div class="p-6 flex flex-col sm:flex-row justify-between sm:items-center">
                    <!-- Flight Details Section -->
                    <div class="flex-grow mb-4 sm:mb-0 sm:mr-6">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-extrabold text-xl text-indigo-700" th:text="${booking.airlineName}">Airline</span>
                            <span class="font-mono text-sm bg-gray-100 text-gray-700 px-2 py-0.5 rounded" th:text="'PNR: ' + ${booking.pnr}">PNR: EKXYZ123</span>
                        </div>
                        <div class="mb-3">
                            <p class="text-2xl font-semibold text-gray-800">
                                <span th:text="${booking.source}">Source</span> &rarr; <span th:text="${booking.destination}">Destination</span>
                            </p>
                            <p class="text-gray-600 text-sm mt-1" th:text="'Departs: ' + ${#temporals.format(booking.departure, 'dd MMM yyyy, HH:mm')}">Departs: 16 Oct 2025, 10:00</p>
                        </div>
                        <div class="flex items-center space-x-4 text-sm">
                             <p class="text-gray-800">
                                Seat: <span class="font-bold" th:text="${booking.seatNo}">14A</span>
                                (<span class="text-gray-600 italic" th:text="${booking.seatTypeName}">Economy</span>)
                            </p>
                             <p class="text-gray-800">
                                Price Paid: <span class="font-bold" th:text="${booking.formattedCalculatedPrice}">$650.00</span>
                             </p>
                        </div>
                    </div>
                    <!-- Status & Actions Section -->
                    <div class="flex-shrink-0 flex flex-col items-start sm:items-end space-y-2 w-full sm:w-auto">
                         <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider"
                               th:text="${booking.status}"
                               th:classappend="${booking.status == 'CONFIRMED' ? 'bg-green-100 text-green-800 ring-1 ring-green-300' :
                                               (booking.status == 'CANCELLED' ? 'bg-red-100 text-red-800 ring-1 ring-red-300' :
                                               (booking.status == 'CHECKED-IN' ? 'bg-blue-100 text-blue-800 ring-1 ring-blue-300' : 'bg-gray-100 text-gray-800 ring-1 ring-gray-300'))}">
                               CONFIRMED
                         </span>
                         <!-- *** UPDATED: Cancel button triggers modal *** -->
                         <form th:if="${booking.isCancellable()}"
                               th:action="@{/bookings/{id}/cancel(id=${booking.bookingId})}" method="post"
                               th:id="'cancel-user-booking-form-' + ${booking.bookingId}">
                             <button type="button" 
                                     th:attr="onclick='showUserCancelConfirmation(\'' + ${booking.bookingId} + '\', \'cancel-user-booking-form-' + ${booking.bookingId} + '\')'"
                                     class="text-xs font-semibold text-red-600 hover:text-red-900 hover:underline">Cancel Booking</button>
                         </form>
                         <span th:if="${!booking.isCancellable() and booking.status != 'CANCELLED'}" class="text-xs text-gray-500 italic">
                             (Cancellation not available)
                         </span>
                    </div>
                </div>
            </div>
        </div>
    </main>

     <!-- *** NEW: Modal Structure for User Booking Cancellation *** -->
    <div id="cancelUserBookingModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Confirm Booking Cancellation</h2>
            <p id="cancelUserBookingModalMessage" class="text-gray-700 mb-6">Are you sure you want to cancel this booking? This action cannot be undone.</p>
            <!-- Removed the "Don't ask again" checkbox for users, can be added back if desired -->
            <div class="flex justify-end space-x-4 mt-6"> <!-- Added margin-top -->
                <button type="button" onclick="closeUserCancelModal()" class="btn btn-secondary">Keep Booking</button> <!-- Use btn class -->
                <button type="button" id="confirmUserCancelButton" class="btn btn-danger">Yes, Cancel Booking</button> <!-- Use btn class -->
            </div>
        </div>
    </div>

    <!-- *** NEW: JavaScript for User Booking Cancel Modal *** -->
    <script>
        let userBookingFormToSubmit = null; // Use a different variable name

        function showUserCancelConfirmation(bookingId, formId) {
            userBookingFormToSubmit = formId; // Store the form ID to submit
            // Customize message if needed, e.g., include PNR or flight details
            var messageElement = document.getElementById('cancelUserBookingModalMessage');
            if(messageElement) {
                 messageElement.textContent = 'Are you sure you want to cancel booking with ID ' + bookingId + '? This action cannot be undone.';
            }
            var modalOverlay = document.getElementById('cancelUserBookingModalOverlay');
            if(modalOverlay) {
                modalOverlay.classList.add('active');
            }
        }

        function closeUserCancelModal() {
            var modalOverlay = document.getElementById('cancelUserBookingModalOverlay');
            if(modalOverlay) {
                modalOverlay.classList.remove('active');
            }
            userBookingFormToSubmit = null; // Clear stored form ID
        }

        var confirmUserButton = document.getElementById('confirmUserCancelButton');
        if(confirmUserButton) {
            confirmUserButton.addEventListener('click', function() {
                if (userBookingFormToSubmit) {
                    var formElement = document.getElementById(userBookingFormToSubmit);
                    if(formElement) {
                        formElement.submit(); // Submit the correct form
                    }
                }
                closeUserCancelModal(); // Close modal after action
            });
        }

        // Optional: Close modal if clicking outside
        var userModalOverlayElement = document.getElementById('cancelUserBookingModalOverlay');
        if (userModalOverlayElement) {
            userModalOverlayElement.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeUserCancelModal();
                }
            });
        }
    </script>
</body>
</html>

